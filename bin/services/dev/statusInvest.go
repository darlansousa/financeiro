package main

import (
    "encoding/json"
    "fmt"
    "io/ioutil"
    "log"
	"net/http"
    "database/sql"
    _ "github.com/go-sql-driver/mysql"
)

type AutoGenerated struct {
    Prices []struct {
        Price float64 `json:"price"`
        Date  string  `json:"date"`
    } `json:"prices"`
}

type Ativo struct {
    ID   int    `json:"id"`
    ATIVO string `json:"name"`
}

func main() {
    var space = "-------------------------------------------------------------------------------"


    fmt.Println("Status Invest: Checar investimentos")
    
    db, err := sql.Open("mysql", "root:Caronte1212#@tcp(127.0.0.1:3306)/financeiro")

    if err != nil {
        panic(err.Error())
    }


    defer db.Close()

    results, err := db.Query("SELECT ID, ATIVO FROM INV_VARIAVEL WHERE VENDIDO='N'")
    if err != nil {
        panic(err.Error())
    }

    for results.Next() {
        var ativo Ativo
       
        err = results.Scan(&ativo.ID, &ativo.ATIVO)
        if err != nil {
            panic(err.Error()) 
        }

        fmt.Println(space)
        fmt.Println("ID: ",ativo.ID,", Ativo: ",ativo.ATIVO)
        fmt.Println(space)

        var url = "https://statusinvest.com.br/category/tickerprice?ticker="+ativo.ATIVO+"&type=-1"
        fmt.Println("url: ",url)
        fmt.Println(space)
        resp, err := http.Get(url)

        if err != nil {
            log.Fatalln(err)
        }

        defer resp.Body.Close()

        body, err := ioutil.ReadAll(resp.Body)

        if err != nil {
            log.Fatalln(err)
        }

        

        var val AutoGenerated 
        if err := json.Unmarshal([]byte(string(body)), &val); err != nil {
            panic(err)
        }

        var quantidade = len(val.Prices)
        if quantidade > 0 {
            var ultimoIndice = quantidade - 1
            fmt.Println("Pre√ßo: ",val.Prices[ultimoIndice].Price, ", Data: ",val.Prices[ultimoIndice].Date)

            insForm, err := db.Prepare("UPDATE INV_VARIAVEL SET VALOR_UNIDADE_ATUAL=?,DATA_ATUALIZACAO=? WHERE ID = ?")
            
            if err != nil {
                panic(err.Error())
            }
            insForm.Exec(
                val.Prices[ultimoIndice].Price,
                val.Prices[ultimoIndice].Date,
                ativo.ID)
            fmt.Println(space)
            fmt.Println("UPDATED")
            
            if err != nil {
                panic(err.Error()) // proper error handling instead of panic in your app
            }
        }else{
            fmt.Println("Nada encontrado.")
        }

        fmt.Println(space)
        
    }


    
}